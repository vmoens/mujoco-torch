name: GPU Tests

on:
  schedule:
    # Nightly at 03:00 UTC
    - cron: "0 3 * * *"
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  gpu-test:
    runs-on: [self-hosted, linux, gpu]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install CUDA PyTorch
        run: pip install torch --index-url https://download.pytorch.org/whl/cu124
      - name: Install JAX (CPU) and MJX
        run: pip install "jax[cpu]" mujoco mujoco-mjx
      - name: Install mujoco-torch with test deps
        run: pip install -e ".[test]"
      - name: Run tests on GPU
        run: pytest test/ -x -v --device cuda
      - name: Run examples on GPU
        run: |
          python examples/e2e_comparison.py --device cuda
          python examples/batched_comparison.py --device cuda
